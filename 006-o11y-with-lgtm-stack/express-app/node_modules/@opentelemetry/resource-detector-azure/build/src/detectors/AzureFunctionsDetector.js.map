{"version":3,"file":"AzureFunctionsDetector.js","sourceRoot":"","sources":["../../../src/detectors/AzureFunctionsDetector.ts"],"names":[],"mappings":";AAAA;;;;;;;;;;;;;;GAcG;;;AAGH,8EAAwE;AACxE,wCASoB;AACpB,oCAMkB;AAClB,oCAAgE;AAEhE,MAAM,kCAAkC,GAAG;IACzC,CAAC,wCAAiB,CAAC,EAAE,yBAAiB;IACtC,CAAC,4BAAkB,CAAC,EAAE,2BAAmB;IACzC,CAAC,8BAAoB,CAAC,EAAE,2BAAmB;CAC5C,CAAC;AAEF;;;GAGG;AACH,MAAM,sBAAsB;IAC1B,MAAM;QACJ,IAAI,UAAU,GAAG,EAAE,CAAC;QACpB,MAAM,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC,yBAAiB,CAAC,CAAC;QAEnD;;;;WAIG;QACH,IAAI,WAAW,IAAI,IAAA,uBAAe,GAAE,EAAE;YACpC,MAAM,gBAAgB,GAAG,OAAO,CAAC,GAAG,CAAC,2BAAmB,CAAC,CAAC;YAC1D,MAAM,gBAAgB,GAAG,OAAO,CAAC,GAAG,CAAC,2BAAmB,CAAC,CAAC;YAE1D,UAAU,GAAG;gBACX,CAAC,6BAAmB,CAAC,EAAE,oCAA0B;gBACjD,CAAC,6BAAmB,CAAC,EAAE,8CAAoC;gBAC3D,CAAC,2BAAiB,CAAC,EAAE,OAAO,CAAC,GAAG,CAAC,mBAAW,CAAC;gBAC7C,CAAC,0BAAgB,CAAC,EAAE,OAAO,CAAC,GAAG;aAChC,CAAC;YAEF,IAAI,WAAW,EAAE;gBACf,UAAU,GAAG;oBACX,GAAG,UAAU;oBACb,CAAC,wCAAiB,CAAC,EAAE,WAAW;iBACjC,CAAC;aACH;YACD,IAAI,gBAAgB,EAAE;gBACpB,UAAU,GAAG;oBACX,GAAG,UAAU;oBACb,CAAC,4BAAkB,CAAC,EAAE,gBAAgB;iBACvC,CAAC;aACH;YACD,IAAI,gBAAgB,EAAE;gBACpB,UAAU,GAAG;oBACX,GAAG,UAAU;oBACb,CAAC,8BAAoB,CAAC,EAAE,gBAAgB;iBACzC,CAAC;aACH;YACD,MAAM,gBAAgB,GAAG,IAAA,2BAAmB,EAAC,WAAW,CAAC,CAAC;YAC1D,IAAI,gBAAgB,EAAE;gBACpB,UAAU,GAAG;oBACX,GAAG,UAAU;oBACb,GAAG,EAAE,CAAC,4CAAoC,CAAC,EAAE,gBAAgB,EAAE;iBAChE,CAAC;aACH;YAED,KAAK,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,MAAM,CAAC,OAAO,CACvC,kCAAkC,CACnC,EAAE;gBACD,MAAM,MAAM,GAAG,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;gBAClC,IAAI,MAAM,EAAE;oBACV,UAAU,GAAG,EAAE,GAAG,UAAU,EAAE,GAAG,EAAE,CAAC,GAAG,CAAC,EAAE,MAAM,EAAE,EAAE,CAAC;iBACtD;aACF;SACF;QACD,OAAO,EAAE,UAAU,EAAE,CAAC;IACxB,CAAC;CACF;AAEY,QAAA,sBAAsB,GAAG,IAAI,sBAAsB,EAAE,CAAC","sourcesContent":["/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ResourceDetector, DetectedResource } from '@opentelemetry/resources';\nimport { ATTR_SERVICE_NAME } from '@opentelemetry/semantic-conventions';\nimport {\n  ATTR_FAAS_MAX_MEMORY,\n  ATTR_FAAS_INSTANCE,\n  ATTR_CLOUD_PROVIDER,\n  CLOUD_PROVIDER_VALUE_AZURE,\n  ATTR_CLOUD_PLATFORM,\n  CLOUD_PLATFORM_VALUE_AZURE_FUNCTIONS,\n  ATTR_CLOUD_REGION,\n  ATTR_PROCESS_PID,\n} from '../semconv';\nimport {\n  WEBSITE_SITE_NAME,\n  WEBSITE_INSTANCE_ID,\n  FUNCTIONS_MEM_LIMIT,\n  REGION_NAME,\n  CLOUD_RESOURCE_ID_RESOURCE_ATTRIBUTE,\n} from '../types';\nimport { getAzureResourceUri, isAzureFunction } from '../utils';\n\nconst AZURE_FUNCTIONS_ATTRIBUTE_ENV_VARS = {\n  [ATTR_SERVICE_NAME]: WEBSITE_SITE_NAME,\n  [ATTR_FAAS_INSTANCE]: WEBSITE_INSTANCE_ID,\n  [ATTR_FAAS_MAX_MEMORY]: FUNCTIONS_MEM_LIMIT,\n};\n\n/**\n * The AzureFunctionsDetector can be used to detect if a process is running in Azure Functions\n * @returns a {@link Resource} populated with data about the environment or an empty Resource if detection fails.\n */\nclass AzureFunctionsDetector implements ResourceDetector {\n  detect(): DetectedResource {\n    let attributes = {};\n    const serviceName = process.env[WEBSITE_SITE_NAME];\n\n    /**\n     * Checks that we are operating within an Azure Function using the function version since WEBSITE_SITE_NAME\n     * will exist in Azure App Service as well and detectors should be mutually exclusive.\n     * If the function version is not present, we check for the website sku to determine if it is a function.\n     */\n    if (serviceName && isAzureFunction()) {\n      const functionInstance = process.env[WEBSITE_INSTANCE_ID];\n      const functionMemLimit = process.env[FUNCTIONS_MEM_LIMIT];\n\n      attributes = {\n        [ATTR_CLOUD_PROVIDER]: CLOUD_PROVIDER_VALUE_AZURE,\n        [ATTR_CLOUD_PLATFORM]: CLOUD_PLATFORM_VALUE_AZURE_FUNCTIONS,\n        [ATTR_CLOUD_REGION]: process.env[REGION_NAME],\n        [ATTR_PROCESS_PID]: process.pid,\n      };\n\n      if (serviceName) {\n        attributes = {\n          ...attributes,\n          [ATTR_SERVICE_NAME]: serviceName,\n        };\n      }\n      if (functionInstance) {\n        attributes = {\n          ...attributes,\n          [ATTR_FAAS_INSTANCE]: functionInstance,\n        };\n      }\n      if (functionMemLimit) {\n        attributes = {\n          ...attributes,\n          [ATTR_FAAS_MAX_MEMORY]: functionMemLimit,\n        };\n      }\n      const azureResourceUri = getAzureResourceUri(serviceName);\n      if (azureResourceUri) {\n        attributes = {\n          ...attributes,\n          ...{ [CLOUD_RESOURCE_ID_RESOURCE_ATTRIBUTE]: azureResourceUri },\n        };\n      }\n\n      for (const [key, value] of Object.entries(\n        AZURE_FUNCTIONS_ATTRIBUTE_ENV_VARS\n      )) {\n        const envVar = process.env[value];\n        if (envVar) {\n          attributes = { ...attributes, ...{ [key]: envVar } };\n        }\n      }\n    }\n    return { attributes };\n  }\n}\n\nexport const azureFunctionsDetector = new AzureFunctionsDetector();\n"]}